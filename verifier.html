<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOYER — Vérification d'éligibilité</title>
  <meta name="description" content="Vérifiez si votre site immobilier est compatible avec NOYER.">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="https://i.imgur.com/3V2jomn.png">
</head>

<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <img src="https://i.imgur.com/3V2jomn.png" alt="Noyer">
        <span class="gradient-text">NOYER</span>
      </a>
      <div class="nav-links">
        <a href="fonctionnement.html" class="nav-link">Comment ça marche</a>
        <a href="plans.html" class="nav-link">Tarifs</a>
        <a href="contact.html" class="nav-link">Contact</a>
        <a href="verifier.html" class="nav-cta">Commencer</a>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="page-header">
      <h1 class="page-title">
        Vérification <span class="gradient-text">d'éligibilité</span>
      </h1>
      <p class="page-subtitle">
        NOYER fonctionne uniquement avec les sites affichant leurs biens de manière statique.<br>
        Entrez les informations ci-dessous pour vérifier la compatibilité.
      </p>
    </div>

    <div class="container container-md">
      <div class="card animate-fadeInUp">
        <form id="eligForm" autocomplete="on">

          <div class="form-group">
            <label class="form-label" for="agency">Nom de l'agence</label>
            <input
              id="agency"
              name="agency"
              type="text"
              class="form-input"
              placeholder="Ex : Belle Maison Immobilier"
              required
            />
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="listUrl">URL de la page des biens (liste)</label>
              <input
                id="listUrl"
                name="listUrl"
                type="url"
                class="form-input"
                placeholder="https://www.votre-agence.fr/biens"
                required
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="itemUrl">URL d'un bien présent sur cette page</label>
              <input
                id="itemUrl"
                name="itemUrl"
                type="url"
                class="form-input"
                placeholder="https://www.votre-agence.fr/biens/maison-123"
                required
              />
            </div>
          </div>

          <div class="warn-box mb-lg">
            <strong>Important :</strong><br>
            • La page liste doit contenir plusieurs biens visibles<br>
            • La page du bien doit afficher les informations directement (sans chargement dynamique)<br>
            • Ne mettez PAS la page d'accueil
          </div>

          <div class="flex gap-md" style="flex-wrap: wrap;">
            <button type="submit" class="btn btn-primary" id="verifyBtn">
              Vérifier l'éligibilité
            </button>
            <a href="fonctionnement.html" id="continueBtn" class="btn btn-primary hidden">
              Continuer
              <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
              </svg>
            </a>
          </div>

          <div id="status" class="mt-md"></div>

        </form>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-logo gradient-text">NOYER</div>
      <div class="footer-links">
        <a href="confidentialite.html" class="footer-link">Politique de confidentialité</a>
        <a href="mentions-legales.html" class="footer-link">Mentions légales</a>
        <a href="conditions-utilisation.html" class="footer-link">CGU</a>
        <a href="conditions-vente.html" class="footer-link">CGV</a>
      </div>
      <p class="footer-copyright">© 2025 Noyer — Publication Automatique</p>
    </div>
  </footer>

  <script>
    const WEBHOOK_URL = 'https://pierre07.app.n8n.cloud/webhook/recieve_url';
    const form = document.getElementById('eligForm');
    const verifyBtn = document.getElementById('verifyBtn');
    const continueBtn = document.getElementById('continueBtn');
    const statusEl = document.getElementById('status');

    function setStatus(msg, type = '') {
      statusEl.className = 'status mt-md ' + type;
      statusEl.innerHTML = msg;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const agency = form.agency.value.trim();
      const listUrl = form.listUrl.value.trim();
      const itemUrl = form.itemUrl.value.trim();

      if (!agency || !listUrl || !itemUrl) {
        setStatus('Veuillez remplir tous les champs.', 'error');
        return;
      }

      verifyBtn.disabled = true;
      verifyBtn.textContent = 'Vérification en cours...';
      setStatus('', '');

      try {
        const payload = { agency, listUrl, itemUrl, source: 'noyer-site' };
        const res = await fetch(WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok) throw new Error(data?.reason || 'Erreur serveur');

        if (data.eligible) {
          setStatus('✓ Site éligible ! Vous pouvez continuer.', 'success');
          continueBtn.classList.remove('hidden');
          verifyBtn.classList.add('hidden');

          localStorage.setItem('agencyName', agency);
          localStorage.setItem('listUrl', listUrl);
          localStorage.setItem('itemUrl', itemUrl);

        } else {
          setStatus('✗ Non éligible : ' + (data.reason || 'site non compatible.'), 'error');
          verifyBtn.disabled = false;
          verifyBtn.textContent = 'Vérifier l\'éligibilité';
        }
      } catch (err) {
        setStatus('⚠ Vérification impossible : ' + err.message, 'warning');
        verifyBtn.disabled = false;
        verifyBtn.textContent = 'Vérifier l\'éligibilité';
      }
    });
  </script>

</body>
</html>
