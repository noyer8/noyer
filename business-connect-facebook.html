<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion Facebook ‚Äî Noyer Business</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #000;
      --text: #e7e7e7;
      --muted: #8f8f8f;
      --panel: #111;
      --accent: #26d19a;
      --accent-dark: #1ea97b;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "JetBrains Mono", monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      padding: 30px 40px;
      display: flex;
      align-items: center;
    }

    header img {
      height: 100px;
      cursor: pointer;
    }

    .container {
      max-width: 650px;
      text-align: center;
      margin-top: 40px;
      padding: 30px;
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid rgba(38,209,154,0.15);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 10px;
      letter-spacing: .1em;
    }

    p {
      line-height: 1.6;
      color: var(--muted);
      margin-bottom: 22px;
      font-size: .95rem;
    }

    .steps {
      text-align: left;
      background: #0c0c0c;
      padding: 18px 20px;
      border-radius: 10px;
      border: 1px solid rgba(38,209,154,0.15);
      margin-bottom: 30px;
    }

    .steps h3 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .steps li {
      margin-bottom: 10px;
      color: var(--text);
      font-size: .9rem;
    }

    #fb-btn {
      margin-top: 25px;
      padding: 14px 26px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #08241a;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: .2s;
    }

    #fb-btn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    #next-btn {
      margin-top: 20px;
      padding: 14px 26px;
      background: #444;
      opacity: 0.4;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
      cursor: not-allowed;
      transition: .2s;
    }

    #next-btn.enabled {
      background: var(--accent);
      opacity: 1;
      cursor: pointer;
    }

    footer {
      margin-top: 60px;
      color: var(--muted);
      font-size: .85rem;
      text-align: center;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

<header>
  <a href="index.html">
    <img src="https://i.imgur.com/3V2jomn.png" alt="Logo Noyer">
  </a>
</header>

<div class="container">

  <h1>Connexion Facebook ‚Äî Business</h1>
  <p>
    Pour activer la publication automatique de votre plan <strong>Noyer Business</strong>,
    vous devez connecter votre Page Facebook professionnelle.
  </p>

  <div class="steps">
    <h3>üîê Pourquoi cette connexion est n√©cessaire ?</h3>
    <ul>
      <li>‚úì Publication automatique de vos biens sur Facebook & Instagram</li>
      <li>‚úì Reels g√©n√©r√©s automatiquement pour chaque nouveau bien</li>
      <li>‚úì Ajout de votre logo sur les photos (si configur√©)</li>
      <li>‚úì Utilisation de vos couleurs de marque dans les visuels</li>
    </ul>
  </div>

  <p>En cliquant sur ¬´ Se connecter avec Facebook ¬ª, vous acceptez de donner les permissions n√©cessaires.</p>

  <button id="fb-btn" onclick="loginWithFacebook()">Se connecter avec Facebook</button>

  <button id="next-btn">Suivant</button>

</div>

<footer>
  ¬© 2025 Noyer ‚Äî Publication Automatique<br>
  <a href="confidentialite.html">Politique de confidentialit√©</a> ¬∑
  <a href="mentions-legales.html">Mentions l√©gales</a>
</footer>

<script>
  // -----------------------------
  // 1Ô∏è‚É£ Connexion Facebook
  // -----------------------------
  function loginWithFacebook() {
    const appId = "2451194691945458";
    const redirectUri = "https://noyer-facebook-backend.onrender.com/auth/facebook/callback";

    const scopes = [
      "pages_manage_posts",
      "pages_read_engagement",
      "pages_show_list",
      "instagram_basic",
      "instagram_content_publish"
    ].join(",");

    const oauthUrl =
      "https://www.facebook.com/v19.0/dialog/oauth" +
      "?client_id=" + appId +
      "&redirect_uri=" + encodeURIComponent(redirectUri) +
      "&response_type=code" +
      "&scope=" + encodeURIComponent(scopes) +
      "&state=business_secure_789";

    window.location.href = oauthUrl;
  }

  // --------------------------------------------------
  // 2Ô∏è‚É£ Activer le bouton "Suivant" apr√®s connexion FB
  // --------------------------------------------------
  const params = new URLSearchParams(window.location.search);
  const nextBtn = document.getElementById("next-btn");

  if (params.get("connected") === "true") {
    nextBtn.classList.add("enabled");

    nextBtn.onclick = async function () {
      // -------------------------------
      // 3Ô∏è‚É£ R√©cup√©rer les donn√©es Business dans localStorage
      // -------------------------------

      // üéØ Description (√âtape 1)
      const style = localStorage.getItem("businessSelectedStyle") || null;
      const customDescription = localStorage.getItem("businessCustomDescription") || null;

      // üéØ Logo (√âtape 2)
      const logoURL = localStorage.getItem("businessLogoURL") || null;

      // üéØ Reels / Branding (√âtape 3 - Reels)
      const color1 = localStorage.getItem("businessPrimaryColor") || null;
      const color2 = localStorage.getItem("businessSecondaryColor") || null;
      const music = localStorage.getItem("businessMusic") || null;
      const duration = localStorage.getItem("businessDuration") || null;
      const notes = localStorage.getItem("businessNotes") || null;

      // üéØ Coordonn√©es (√âtape coordonn√©es)
      const agence = localStorage.getItem("businessAgencyName") || "";
      const email = localStorage.getItem("businessEmail") || "";
      const telephone = localStorage.getItem("businessPhone") || "";
      const responsable = localStorage.getItem("businessResponsable") || "";

      // -------------------------------
      // 4Ô∏è‚É£ Construire le payload pour n8n
      // -------------------------------
      const payload = {
        plan: "BUSINESS",
        style,
        customDescription,
        logoURL,
        color1,
        color2,
        music,
        duration,
        notes,
        agence,
        email,
        telephone,
        responsable
      };

      console.log("üì¶ Payload Business envoy√© :", payload);

      // -------------------------------
      // 5Ô∏è‚É£ Envoi au backend ‚Üí webhook n8n
      // -------------------------------
      try {
        await fetch("https://noyer-facebook-backend.onrender.com/send-infos-to-webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        console.log("üì§ Donn√©es Business envoy√©es au backend ‚Üí webhook n8n");
      } catch (e) {
        console.error("‚ùå Erreur lors de l‚Äôenvoi au webhook :", e);
        alert("Une erreur est survenue lors de l‚Äôenvoi des informations. Vous pouvez r√©essayer.");
        return;
      }

      // -------------------------------
      // 6Ô∏è‚É£ Cr√©ation de la session STRIPE ‚Äî BUSINESS
      // -------------------------------
      try {
        const response = await fetch("https://noyer-facebook-backend.onrender.com/create-checkout-session-business", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          console.error("‚ùå R√©ponse Stripe invalide :", data);
          alert("Erreur Stripe : impossible de cr√©er la session Business.");
        }
      } catch (e) {
        console.error("‚ùå Erreur Stripe Business :", e);
        alert("Erreur Stripe : impossible de cr√©er la session Business.");
      }
    };
  }
</script>

</body>
</html>
