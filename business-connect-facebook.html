<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion Facebook ‚Äî Noyer Business</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #000;
      --text: #e7e7e7;
      --muted: #8f8f8f;
      --panel: #111;
      --accent: #26d19a;
      --accent-dark: #1ea97b;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "JetBrains Mono", monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      padding: 30px 40px;
      display: flex;
      align-items: center;
    }

    header img {
      height: 100px;
      cursor: pointer;
    }

    .container {
      max-width: 650px;
      text-align: center;
      margin-top: 40px;
      padding: 30px;
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid rgba(38, 209, 154, 0.15);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
    }

    h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 10px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }

    p {
      line-height: 1.6;
      color: var(--muted);
      margin-bottom: 22px;
      font-size: 0.95rem;
    }

    .steps {
      text-align: left;
      background: #0c0c0c;
      padding: 18px 20px;
      border-radius: 10px;
      border: 1px solid rgba(38, 209, 154, 0.15);
      margin-bottom: 30px;
    }

    .steps h3 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .steps li {
      margin-bottom: 10px;
      color: var(--text);
      font-size: 0.9rem;
    }

    #fb-btn {
      margin-top: 25px;
      padding: 14px 26px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #08241a;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: 0.2s;
    }

    #fb-btn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    #next-btn {
      margin-top: 20px;
      padding: 14px 26px;
      background: #444;
      opacity: 0.4;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
      cursor: not-allowed;
      transition: 0.2s;
    }

    #next-btn.enabled {
      background: var(--accent);
      opacity: 1;
      cursor: pointer;
    }

    footer {
      margin-top: 60px;
      color: var(--muted);
      font-size: 0.85rem;
      text-align: center;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }

    footer a:hover {
      text-decoration: underline;
    }
  </style>
</head>

<body>

<header>
  <a href="index.html">
    <img src="https://i.imgur.com/3V2jomn.png" alt="Logo Noyer">
  </a>
</header>

<div class="container">

  <h1>Connexion Facebook ‚Äî Business</h1>
  <p>
    Pour activer la publication automatique <strong>Business</strong>, vous devez connecter votre Page Facebook professionnelle.
  </p>

  <div class="steps">
    <h3>üîê Pourquoi cette connexion est n√©cessaire ?</h3>
    <ul>
      <li>‚úì Publications illimit√©es sur Facebook & Instagram</li>
      <li>‚úì Reels pour chaque bien, g√©n√©r√©s automatiquement</li>
      <li>‚úì Ajout de votre logo sur les photos</li>
      <li>‚úì Priorit√© & optimisation totale des horaires de publication</li>
    </ul>
  </div>

  <p>En cliquant sur ¬´ Se connecter avec Facebook ¬ª, vous acceptez de donner les permissions n√©cessaires.</p>

  <button id="fb-btn" onclick="loginWithFacebook()">Se connecter avec Facebook</button>

  <button id="next-btn">Suivant</button>

</div>

<footer>
  ¬© 2025 Noyer ‚Äî Publication Automatique<br>
  <a href="confidentialite.html">Politique de confidentialit√©</a> ¬∑
  <a href="mentions-legales.html">Mentions l√©gales</a>
</footer>

<script>
  // -----------------------------------
  //  Connexion Facebook (OAuth)
  // -----------------------------------
  function loginWithFacebook() {
    const appId = "2451194691945458";
    const redirectUri = "https://noyer-facebook-backend.onrender.com/auth/facebook/callback";

    const scopes = [
      "pages_manage_posts",
      "pages_read_engagement",
      "pages_show_list",
      "instagram_basic",
      "instagram_content_publish"
    ].join(",");

    const oauthUrl =
      "https://www.facebook.com/v19.0/dialog/oauth" +
      "?client_id=" + appId +
      "&redirect_uri=" + encodeURIComponent(redirectUri) +
      "&response_type=code" +
      "&scope=" + encodeURIComponent(scopes) +
      "&state=business_secure_789";

    window.location.href = oauthUrl;
  }

  // -----------------------------------
  //  Bouton "Suivant" apr√®s connexion
  // -----------------------------------
  const params = new URLSearchParams(window.location.search);
  const nextBtn = document.getElementById("next-btn");

  if (params.get("connected") === "true") {
    nextBtn.classList.add("enabled");

    nextBtn.onclick = async function () {

      // 1Ô∏è‚É£ R√âCUP√âRER TOUTES LES DONN√âES BUSINESS DU LOCALSTORAGE

      // Infos agence (Business 1)
      const agency =
        JSON.parse(localStorage.getItem("businessAgencyInfo") || "{}") ||
        JSON.parse(localStorage.getItem("agencyInfoBusiness") || "{}");

      // Jours s√©lectionn√©s (Business 1)
      const businessDays = JSON.parse(
        localStorage.getItem("businessSelectedDays") ||
        localStorage.getItem("businessDays") ||
        "[]"
      );

      // Description & style (Business 2)
      const businessStyle = localStorage.getItem("businessSelectedStyle") || null;
      const businessCustomDescription = localStorage.getItem("businessCustomDescription") || null;

      // Pr√©f√©rences Reels (Business 3)
      const reelsPrefs = JSON.parse(localStorage.getItem("businessReelsPreferences") || "{}");

      // Logo (Business 4 ou autre page)
      const logoURL = localStorage.getItem("logoURL") || "";

      // 2Ô∏è‚É£ CONSTITUER LE PAYLOAD COMPLET
      const payload = {
        // Plan
        plan: "BUSINESS",

        // Jours Business
        days: businessDays,

        // Texte / style
        style: businessStyle,
        customDescription: businessCustomDescription,

        // Infos agence
        agence: agency.agence || "",
        email: agency.email || "",
        telephone: agency.telephone || "",
        responsable: agency.responsable || "",

        // Branding / Reels
        color1: reelsPrefs.primaryColor || null,
        color2: reelsPrefs.secondaryColor || null,
        musicPreference: reelsPrefs.musicPreference || null,
        reelDuration: reelsPrefs.reelDuration || null,
        extraNotes: reelsPrefs.extraNotes || "",

        // Logo
        logoURL: logoURL
      };

      console.log("üì¶ Payload BUSINESS envoy√© :", payload);

      // 3Ô∏è‚É£ ENVOYER AU BACKEND ‚Üí WEBHOOK n8n
      try {
        await fetch("https://noyer-facebook-backend.onrender.com/send-infos-to-webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        console.log("üì§ Donn√©es BUSINESS envoy√©es au backend ‚Üí webhook n8n");
      } catch (e) {
        console.error("Erreur lors de l‚Äôenvoi au webhook :", e);
        alert("Une erreur est survenue lors de l‚Äôenvoi des informations. Merci de r√©essayer.");
        return;
      }

      // 4Ô∏è‚É£ STRIPE ‚Äî SESSION CHECKOUT BUSINESS
      try {
        const response = await fetch("https://noyer-facebook-backend.onrender.com/create-checkout-session-business", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          console.error("R√©ponse Stripe inattendue :", data);
          alert("Erreur Stripe : impossible de cr√©er la session Business.");
        }
      } catch (err) {
        console.error("Erreur Stripe :", err);
        alert("Erreur Stripe : impossible de cr√©er la session Business.");
      }
    };
  }
</script>

</body>
</html>
