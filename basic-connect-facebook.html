<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NOYER — Connexion Facebook</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" href="https://i.imgur.com/3V2jomn.png">
</head>

<body>
  <!-- Navigation -->
  <nav class="nav">
    <div class="nav-container">
      <a href="index.html" class="nav-logo">
        <img src="https://i.imgur.com/3V2jomn.png" alt="Noyer">
        <span class="gradient-text">NOYER</span>
      </a>
      <div class="nav-links">
        <a href="fonctionnement.html" class="nav-link">Comment ça marche</a>
        <a href="plans.html" class="nav-link">Tarifs</a>
        <a href="contact.html" class="nav-link">Contact</a>
        <a href="verifier.html" class="nav-cta">Commencer</a>
      </div>
    </div>
  </nav>

  <div class="page-wrapper">
    <div class="page-header">
      <h1 class="page-title">
        Connexion <span class="gradient-text">Facebook</span>
      </h1>
      <p class="page-subtitle">
        Connectez votre Page Facebook professionnelle pour activer la publication automatique.
      </p>
    </div>

    <div class="container container-sm">
      <div class="card animate-fadeInUp text-center">

        <div class="feature-icon" style="margin: 0 auto var(--space-lg); background: linear-gradient(135deg, #1877F2 0%, #42A5F5 100%);">
          <svg fill="currentColor" viewBox="0 0 24 24" style="width: 24px; height: 24px; color: white;">
            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
          </svg>
        </div>

        <h3 class="mb-md">Pourquoi cette connexion ?</h3>

        <div class="text-left mb-lg" style="background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: var(--space-md);">
          <div class="pricing-feature">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #10b981;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Publier automatiquement vos nouvelles annonces</span>
          </div>
          <div class="pricing-feature">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #10b981;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Gérer vos photos et descriptions optimisées</span>
          </div>
          <div class="pricing-feature">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #10b981;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Vérifier chaque jour les nouveaux biens</span>
          </div>
          <div class="pricing-feature">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 20px; height: 20px; color: #10b981;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            <span>Poster au meilleur moment pour maximiser votre visibilité</span>
          </div>
        </div>

        <p class="mb-lg" style="font-size: 0.9rem; color: var(--text-muted);">
          En cliquant sur « Se connecter avec Facebook », vous acceptez de donner les permissions nécessaires.
        </p>

        <button id="fb-btn" class="btn btn-primary btn-lg" style="width: 100%; background: linear-gradient(135deg, #1877F2 0%, #42A5F5 100%);" onclick="loginWithFacebook()">
          Se connecter avec Facebook
        </button>

        <button id="next-btn" class="btn btn-secondary mt-md disabled" style="width: 100%;">
          Finaliser l'inscription
          <svg class="btn-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3"></path>
          </svg>
        </button>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-logo gradient-text">NOYER</div>
      <div class="footer-links">
        <a href="confidentialite.html" class="footer-link">Politique de confidentialité</a>
        <a href="mentions-legales.html" class="footer-link">Mentions légales</a>
        <a href="conditions-utilisation.html" class="footer-link">CGU</a>
        <a href="conditions-vente.html" class="footer-link">CGV</a>
      </div>
      <p class="footer-copyright">© 2025 Noyer — Publication Automatique</p>
    </div>
  </footer>

  <script>
    function loginWithFacebook() {
      const appId = "2451194691945458";
      const redirectUri = "https://noyer-facebook-backend.onrender.com/auth/facebook/callback";

      const scopes = [
        "pages_manage_posts",
        "pages_read_engagement",
        "pages_show_list",
        "instagram_basic",
        "instagram_content_publish"
      ].join(",");

      const oauthUrl =
        "https://www.facebook.com/v19.0/dialog/oauth" +
        "?client_id=" + appId +
        "&redirect_uri=" + encodeURIComponent(redirectUri) +
        "&response_type=code" +
        "&scope=" + encodeURIComponent(scopes) +
        "&state=secure_noyer_123";

      window.location.href = oauthUrl;
    }

    const params = new URLSearchParams(window.location.search);
    const nextBtn = document.getElementById("next-btn");

    if (params.get("connected") === "true") {
      nextBtn.classList.remove("disabled");
      document.getElementById("fb-btn").style.display = "none";

      nextBtn.onclick = async function () {
        const agencyInfo = JSON.parse(localStorage.getItem("agencyInfo") || "{}");

        const payload = {
          days: JSON.parse(localStorage.getItem("selectedDays") || "[]"),
          style: localStorage.getItem("selectedStyle") || null,
          customDescription: localStorage.getItem("customDescription") || null,
          agence: agencyInfo.agence || "",
          email: agencyInfo.email || "",
          telephone: agencyInfo.telephone || "",
          responsable: agencyInfo.responsable || ""
        };

        await fetch("https://noyer-facebook-backend.onrender.com/send-infos-to-webhook", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const response = await fetch("https://noyer-facebook-backend.onrender.com/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await response.json();

        if (data.url) {
          window.location.href = data.url;
        } else {
          alert("Erreur Stripe : impossible de créer la session.");
        }
      };
    }
  </script>

</body>
</html>
