<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Connexion Facebook ‚Äî Noyer Premium</title>

  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />

  <style>
    :root {
      --bg: #000;
      --text: #e7e7e7;
      --muted: #8f8f8f;
      --panel: #111;
      --accent: #26d19a;
      --accent-dark: #1ea97b;
    }

    body {
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: "JetBrains Mono", monospace;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    header {
      width: 100%;
      padding: 30px 40px;
      display: flex;
      align-items: center;
    }

    header img {
      height: 100px;
      cursor: pointer;
    }

    .container {
      max-width: 650px;
      text-align: center;
      margin-top: 40px;
      padding: 30px;
      background: var(--panel);
      border-radius: 16px;
      border: 1px solid rgba(38,209,154,0.15);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }

    h1 {
      color: var(--accent);
      font-size: 2rem;
      margin-bottom: 10px;
      letter-spacing: .1em;
    }

    p {
      line-height: 1.6;
      color: var(--muted);
      margin-bottom: 22px;
      font-size: .95rem;
    }

    .steps {
      text-align: left;
      background: #0c0c0c;
      padding: 18px 20px;
      border-radius: 10px;
      border: 1px solid rgba(38,209,154,0.15);
      margin-bottom: 30px;
    }

    .steps h3 {
      font-size: 1rem;
      color: var(--accent);
      margin-bottom: 12px;
    }

    .steps li {
      margin-bottom: 10px;
      color: var(--text);
      font-size: .9rem;
    }

    #fb-btn {
      margin-top: 25px;
      padding: 14px 26px;
      background: var(--accent);
      border: none;
      border-radius: 10px;
      color: #08241a;
      font-weight: bold;
      font-size: 1rem;
      cursor: pointer;
      transition: .2s;
    }

    #fb-btn:hover {
      background: var(--accent-dark);
      transform: translateY(-2px);
    }

    #next-btn {
      margin-top: 20px;
      padding: 14px 26px;
      background: #444;
      opacity: 0.4;
      border: none;
      border-radius: 10px;
      color: #fff;
      font-weight: bold;
      cursor: not-allowed;
      transition: .2s;
    }

    #next-btn.enabled {
      background: var(--accent);
      opacity: 1;
      cursor: pointer;
    }

    footer {
      margin-top: 60px;
      color: var(--muted);
      font-size: .85rem;
      text-align: center;
    }

    footer a {
      color: var(--accent);
      text-decoration: none;
    }
  </style>
</head>

<body>

<header>
  <a href="index.html">
    <img src="https://i.imgur.com/3V2jomn.png" alt="Logo Noyer">
  </a>
</header>

<div class="container">

  <h1>Connexion Facebook ‚Äî Premium</h1>
  <p>
    Pour activer la publication automatique premium, vous devez connecter votre Page Facebook professionnelle.
  </p>

  <div class="steps">
    <h3>üîê Pourquoi cette connexion est n√©cessaire ?</h3>
    <ul>
      <li>‚úì Publier automatiquement vos annonces 3 fois par semaine</li>
      <li>‚úì S√©lection intelligente des heures les plus performantes</li>
      <li>‚úì Descriptions premium r√©√©crites avec IA</li>
      <li>‚úì Suivi avanc√© des performances</li>
    </ul>
  </div>

  <p>En cliquant sur ¬´ Se connecter avec Facebook ¬ª, vous acceptez de donner les permissions n√©cessaires.</p>

  <button id="fb-btn" onclick="loginWithFacebook()">Se connecter avec Facebook</button>

  <button id="next-btn">Suivant</button>

</div>

<footer>
  ¬© 2025 Noyer ‚Äî Publication Automatique<br>
  <a href="confidentialite.html">Politique de confidentialit√©</a> ¬∑
  <a href="mentions-legales.html">Mentions l√©gales</a>
</footer>

<script>
  function loginWithFacebook() {
    const appId = "2451194691945458";
    const redirectUri = "https://noyer-facebook-backend.onrender.com/auth/facebook/callback";

    const scopes = [
      "pages_manage_posts",
      "pages_read_engagement",
      "pages_show_list",
      "instagram_basic",
      "instagram_content_publish"
    ].join(",");

    const oauthUrl =
      "https://www.facebook.com/v19.0/dialog/oauth" +
      "?client_id=" + appId +
      "&redirect_uri=" + encodeURIComponent(redirectUri) +
      "&response_type=code" +
      "&scope=" + encodeURIComponent(scopes) +
      "&state=premium_secure_456";

    window.location.href = oauthUrl;
  }

  // --------------------------------------------------
  //  ACTIVER BOUTON SUIVANT APR√àS CONNEXION FB
  // --------------------------------------------------
  const params = new URLSearchParams(window.location.search);
  const nextBtn = document.getElementById("next-btn");

  if (params.get("connected") === "true") {
    nextBtn.classList.add("enabled");

    nextBtn.onclick = async function () {

      // 1Ô∏è‚É£ R√©cup√©ration des donn√©es PREMIUM
      const agency = JSON.parse(localStorage.getItem("agencyInfo") || "{}");

      const payload = {
        days: JSON.parse(localStorage.getItem("selectedPremiumDays") || "[]"),
        style: localStorage.getItem("selectedStyle") || null,
        customDescription: localStorage.getItem("customDescription") || null,
        agence: agency.agence || "",
        email: agency.email || "",
        telephone: agency.telephone || "",
        responsable: agency.responsable || "",
        plan: "PREMIUM"
      };

      console.log("üì¶ Payload Premium envoy√© :", payload);

      // 2Ô∏è‚É£ Envoi au backend ‚Üí webhook n8n
      await fetch("https://noyer-facebook-backend.onrender.com/send-infos-to-webhook", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      console.log("üì§ Donn√©es premium envoy√©es au webhook");

      // 3Ô∏è‚É£ STRIPE ‚Äî PREMIUM
      const response = await fetch("https://noyer-facebook-backend.onrender.com/create-checkout-session-premium", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const data = await response.json();

      if (data.url) {
        window.location.href = data.url;
      } else {
        alert("Erreur Stripe : impossible de cr√©er la session premium.");
      }
    };
  }
</script>

</body>
</html>
